# ğŸ“Š Data Engineering â€“ Import & Transform Billing Data (Flash / J&T)

## 1. Tá»•ng quan (Overview)

Dá»± Ã¡n nÃ y lÃ  má»™t **data ingestion & transformation script** dÃ¹ng trong pipeline Ä‘á»‘i soÃ¡t cÆ°á»›c váº­n chuyá»ƒn.

Chá»©c nÄƒng chÃ­nh:

* Ingest dá»¯ liá»‡u billing tá»« **Excel**
* Load vÃ o **PostgreSQL (raw/source layer)**
* LÃ m sáº¡ch & loáº¡i bá» trÃ¹ng láº·p
* Ãp dá»¥ng **business rules / policy** Ä‘á»ƒ tÃ­nh phÃ­
* Ghi dá»¯ liá»‡u sang **curated/master layer** phá»¥c vá»¥ bÃ¡o cÃ¡o & Ä‘á»‘i soÃ¡t

Pipeline phÃ¹ há»£p cho mÃ´ hÃ¬nh dá»¯ liá»‡u:

```text
Excel (Source) â†’ Raw Table (msx_data)
              â†’ Deduplication
              â†’ Business Rules / Policy Join
              â†’ Curated Table (mst_data)
```

---

## 2. Pháº¡m vi & Use cases

* Äá»‘i soÃ¡t cÆ°á»›c váº­n chuyá»ƒn (Logistics / Fulfillment)
* Chuáº©n hoÃ¡ dá»¯ liá»‡u billing tá»« nhiá»u hÃ£ng váº­n chuyá»ƒn
* LÃ m nguá»“n cho:

  * BI / Reporting
  * Finance reconciliation
  * Audit ná»™i bá»™

---

## 3. Kiáº¿n trÃºc dá»¯ liá»‡u (Data Architecture)

### 3.1 Logical Layers

| Layer        | Schema     | Má»¥c Ä‘Ã­ch                                 |
| ------------ | ---------- | ---------------------------------------- |
| Source / Raw | `msx_data` | LÆ°u dá»¯ liá»‡u gá»‘c tá»« Excel                 |
| Policy       | public     | LÆ°u báº£ng chÃ­nh sÃ¡ch chiáº¿t kháº¥u           |
| Curated      | `mst_data` | Dá»¯ liá»‡u Ä‘Ã£ chuáº©n hoÃ¡, sáºµn sÃ ng phÃ¢n tÃ­ch |

### 3.2 Báº£ng sá»­ dá»¥ng

**Raw tables**

* `msx_flash_230321878_data`
* `msx_jnt_230321878_data`

**Policy tables**

* `flash_policy`
* `jnt_policy`

**Curated tables**

* `mst_flash_230321878_data`
* `mst_jnt_230321878_data`

Join key:

```text
msx."Sender Name" = policy.warehouse_name
```

---

## 4. Luá»“ng xá»­ lÃ½ chi tiáº¿t (Processing Flow)

1. User chá»n **carrier type** (Flash / J&T)
2. User chá»n má»™t hoáº·c nhiá»u file Excel
3. Äá»c sheet (loáº¡i trá»« `BILLING STATEMENT`)
4. Load dá»¯ liá»‡u vÃ o raw table
5. Deduplicate dá»¯ liá»‡u theo business key
6. Ãp dá»¥ng há»‡ sá»‘ chiáº¿t kháº¥u theo carrier
7. Join vá»›i báº£ng policy
8. TÃ­nh toÃ¡n phÃ­ & insert sang curated table

---

## 5. Business Rules & Transformations

### 5.1 Há»‡ sá»‘ chiáº¿t kháº¥u

| Carrier | Shipping | Return |
| ------- | -------- | ------ |
| Flash   | 50%      | 80%    |
| J&T     | 40%      | 0%     |

### 5.2 CÃ´ng thá»©c chÃ­nh (vÃ­ dá»¥)

* **Shipping Fee (chuáº©n hoÃ¡)**

```text
Original / (1 - Shipping Discount)
â†’ Apply policy discount
```

* **Return Fee Adjustment**

```text
Return Fee * return_fee_discount
```

* **Total Fee**

```text
COD Fee + Insurance Fee + Adjusted Return Fee + Adjusted Shipping Fee
```

---

## 6. YÃªu cáº§u ká»¹ thuáº­t (Technical Requirements)

### Runtime

* Python >= 3.8
* PostgreSQL >= 12

### Python Dependencies

```bash
pip install pandas psycopg2
```

---

## 7. Váº­n hÃ nh (Execution)

Cháº¡y script:

```bash
python main.py
```

Há»‡ thá»‘ng sáº½ log tiáº¿n trÃ¬nh import & transform ra terminal.

---

## 8. Data Quality & Constraints

* KhÃ´ng enforce primary key á»Ÿ raw layer
* Deduplication dá»±a trÃªn táº­p business columns
* KhÃ´ng kiá»ƒm soÃ¡t schema drift tá»« file Excel
* KhÃ´ng há»— trá»£ incremental load

---

## 9. Háº¡n cháº¿ & Rá»§i ro

* Hard-code database credentials
* KhÃ´ng cÃ³ transaction rollback tá»«ng file
* KhÃ´ng audit log theo batch
* KhÃ´ng phÃ¹ há»£p cháº¡y song song

---

## 10. Äá»‹nh hÆ°á»›ng má»Ÿ rá»™ng

* TÃ¡ch config sang `.env`
* ThÃªm batch_id / ingestion_time
* Ãp dá»¥ng staging table
* Chuyá»ƒn sang Airflow / Prefect
* Chuáº©n hoÃ¡ theo mÃ´ hÃ¬nh **Medallion (Bronze / Silver / Gold)**

---

## 11. Äá»‘i tÆ°á»£ng sá»­ dá»¥ng

* Data Engineer
* Data Analyst
* Finance / Ops
* Internal Audit

---

ğŸ“Œ README nÃ y Ä‘Æ°á»£c viáº¿t theo **Data Engineering documentation style**, táº­p trung vÃ o:

* Data flow
* Business rules
* Data quality
* Kháº£ nÄƒng má»Ÿ rá»™ng pipeline

